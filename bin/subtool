#!/usr/bin/env node

/**
 * The subtool commandline interface.
 */


/**
 * Module dependencies.
 */
var fs = require('fs');
var clc = require('cli-color');
var program = require('commander');
var pkg = require('./../package.json');
var license = require('./../src/license');
var log = require('./../src/log');
var readme = require('./../src/readme');
var subfile = require('./../src/subfile');
var travis = require('./../src/travis-ci');

/**
 * Some variables we need globally.
 */
var descColor = clc.green;
var infoColor = clc.yellow;
var logConfig = {silent: false, color: 'green'};

/**
 * Set the version of the cli and add some additional infos to help
 */
program
  .version(pkg.version)
  .option('-S, --silent', 'silent mode')
  .on('--help', function(){
    console.log('  Infos:');
    console.log();
    console.log(infoColor('    github.com/subtub/subtool'));
    console.log();
  });

/**
 * The config command
 */
program
  .command('config')
  .description('subtool config commands')
  .option('-l, -lint', 'lint the config file')
  .action(function(options) {
    console.log('todo ');
    console.log(options);
  })

/**
 * The readme command
 */
program
  .command('readme')
  .description('generate the readme file')
  .option('-s, --save', 'save the file')
  .action(function(options) {
    // Some config stuff we need to run first.
    subfile.load(process.env.PWD+'/.subfile', function(configData) {
      if (configData === false) {
        log('No .subfile file was found. please create one.', logConfig);
        process.exit(1);
      } else {
        readme.readme(configData, function(data) {
          if (options.save) {
            fs.writeFile('README.md', data, function (err) {
              if (err) throw err;
              log('It\'s saved!', logConfig);
            });
          } else {
            log(data, logSilent);
          };
        });
      }
    });
  })
  .on('--help', function() {
    console.log('  Examples:');
    console.log();
    console.log(infoColor('    $ subtool readme'));
    console.log();
  });

/**
 * The license command
 */
program
  .command('license <type>')
  .description(descColor('choose between the following license: apache, freebsd, isc, mit, newbsd'))
  .option('-a, --author [name]', 'the author name we want to use')
  .option('-d, --date [year]', 'the year')
  .option('-s, --save', 'save the license file')
  // TODO:
  //.option('-s, --save', 'save the file')
  .action(function(type, options) {
    // If options doesn't exists, set some default values.
    var author = options.author || 'subtub';
    var date = options.date || (new Date()).getFullYear();
    
    // check if we want to save a LICENSE.txt file.
    // Else we print out the license.
    if (options.save) {
      license.save(process.env.PWD, type, author, date, logSilent, function(data) {
        log(license.FILENAME+' saved to current directory.', logSilent)
      });
    }
    else {
      license.get(type, author, date, logConfig, function(data) {
        console.log(data);
      });
    };
  })
  .on('--help', function() {
    console.log('  Examples:');
    console.log();
    console.log(infoColor('    $ subtool license mit -a subtub'));
    console.log(infoColor('    $ subtool license mit -a "karl koch" -y 2013'));
    console.log(infoColor('    $ subtool license mit -a "karl koch" -y "2010 - 2013"'));
    console.log();
  });

/**
 * The templates command
 */
program
  .command('tpl [type]')
  .description(descColor('choose between the following template types: p5, node'))
  .option('-t, --template [name]', 'the template we want to use')
  .option('-l, --list', 'list the available templates')
  .action(function(type, options) {
    if (type === 'p5') {
      if (options.list) {
        var list = fs.readdirSync(process.env.PWD+'/templates/processing')
        log('choose between the following templates:\n', logConfig);
        for (var i=0; i<list.length; i++) {
          log('  '+list[i], logConfig);
        };
        log('', logConfig);
      };
      if (options.template) {
        var tmp = cat(process.env.PWD+'/templates/processing/'+options.template+'.pde')
        console.log(tmp);
      };
    };
  })
  .on('--help', function() {
    console.log('  Examples:');
    console.log();
    console.log(infoColor('    $ subtool template p5 -t class'));
    console.log();
  });

/**
 * Parse the process arguments
 */
program.parse(process.argv);

/**
 * Check some main options and set variables.
 */
if (program.silent) {
  logConfig.silent = true;
};

/**
 * If no command exist, show help
 */
if (!program.args.length) program.help();
